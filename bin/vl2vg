#!/usr/bin/env node
// Compile a vegalite spec to vega

'use strict';

var helpText =
  'Compile a vega-lite spec to vega.\n\n' +
  'Usage: vl2vg vega_lite_json_file [data_stats] [-p]\n\n' +
  'data_stats only has to be set if the data is not embedded in the vega-lite json file. '+
  // TODO(kanitw): make stats optional (https://github.com/uwdata/vega-lite/issues/465) and remove
  // the following line
  'You will get an error if you forget to provide statistics and do not embed data into the spec.';

// import required libraries
var fs = require('fs'),
    vl = require('../src/vl'),
    // TODO(kanitw): extract this to another library
    json3 = require('../lib/json3-compactstringify.js');

// arguments
var args = require('yargs')
  .usage(helpText)
  .demand(1)
  .boolean('p').alias('p', 'pretty')
  .describe('p', 'Output human readable/pretty spec.')
  .argv;

// input files
var specFile = args._[0],
    statsFile = args._[1] || null;

// load spec, compile vg spec
fs.readFile(specFile, 'utf8', function(err, text) {
  if (err) throw err;
  var spec = JSON.parse(text);
  // load stats if exists
  if (statsFile) {
  	fs.readFile(statsFile, 'utf8', function(err, text) {
  		if (err) throw err;
  		var stats = JSON.parse(text);
  		compile(spec, stats);
  	});
  } else {
  	compile(spec, null);
  }
});

function compile(vlSpec, stats) {
  var vgSpec = vl.compile(vlSpec, stats);
  if (args.p) {
  	process.stdout.write(json3.stringify(vgSpec, null, 1, 80));
  } else {
  	process.stdout.write(JSON.stringify(vgSpec));
  }
}
