<!DOCTYPE html>
<html>
<head>
  <title>Vegalite UI</title>
  <script src="lib/d3.v3.min.js"></script>
  <script src="lib/vega.js"></script>
  <script src="lib/json3-nicestringify.js"></script>
  <script src="src/aggregate.js"></script>
  <script src="src/bin.js"></script>
  <script src="src/vegalite.js"></script>
  <style>
* {
  font-family: Helvetica Neue;
}

#ctrl {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 1em;
  float:left;
  width: 300px;
}

#ctrl .mark {
  margin-bottom: 0.3em;
}
#ctrl .toggles {
  margin-top: 0.3em;
}

#ctrl .main{
  margin-bottom: 1em;
}

#ctrl textarea.vlcode{
  width: 290px;
  height: 175px;
  padding-right: 0.3em;
}

#ctrl textarea.vgcode{
  width: 290px;
  height: 350px;
  padding-right: 0.3em;
}

#ctrl span{
  font-weight: 500;
  font-size: 14px;
}

#ctrl span.label {
  display: inline-block;
  width: 60px;
}

#ctrl label span{
  font-size: 12px;
  width: 100px;
}

#ctrl select {
  width: 80px;
}
#ctrl select.type {
  width: 50px;
}
#ctrl select.data {
  width: 210px;
}
#ctrl span.header { width: 80px; }
#ctrl span.header.h0 { width: 60px; }
#ctrl span.header.h3 { width: 50px; }

#vis {
  margin-left: 320px;
}
</style>

</head>
<body>
  <div id="ctrl">
  </div>
  <div id="vis"></div>
<script type="text/javascript">
var datasets = [
  "-",
  "data/barley.json",
  "data/cars.json",
  "data/crimea.json",
  "data/driving.json",
  "data/iris.json",
  "data/jobs.json",
  "data/population.json"
];

function load(url) {
  d3.json(url, function(err, data) {
    var schema = {};
    for (var k in data[0]) {
      //TODO(kanitw): better type inference here
      schema[k] = (typeof data[0][k] === "number") ? vl.dataTypes.Q : vl.dataTypes.O;
    }
    run(data, schema);
  });
}

// ------

function init() {
  var root = d3.select("#ctrl");

  var main = root.append("div").attr("class","main");
  var vlcode = root.append("div").attr("class", "main")
    .style("display","none");
  var vgcode = root.append("div").attr("class", "main")
    .style("display","none");
  var config = root.append("div").attr("class","main")
    .style("display","none");


  // data set selector
  var dsel = main.append("div").attr("class","dsel");
  dsel.append("span").attr("class","label").text("data");
  dsel.append("select")
    .attr("class", "data")
    .on("change", function() {
        var url = this.options[this.selectedIndex].value;
        load(url);
      })
    .selectAll("option")
      .data(datasets)
    .enter().append("option")
      .attr("value", function(d) { return d; })
      .text(function(d) { return d; });

  // choose mark type
  var mark = main.append("div").attr("class", "mark");
  mark.append("span").attr("class","label").text("mark");
  mark.append("select")
    .attr("class", "mark")
    .on("change", update)
    .selectAll("option")
      .data(["point", "bar", "line", "area", "circle", "square", "text"])
    .enter().append("option")
      .attr("value", function(d) { return d; })
      .text(function(d) { return d; });

  // header labels
  var head = main.append("div").selectAll("span.header")
      .data(["","function","data","type"])
    .enter().append("span")
      .attr("class", function(d,i) { return "header label h"+i; })
      .text(function(d) { return d; });

  // controls for each visual encoding variable
  var ctrl = main.selectAll("div.enc")
      .data(["x","y","size","color","alpha","shape","text"])
    .enter().append("div").attr("class", "enc");

  ctrl.append("span").attr("class","label").text(function(d) { return d; });

  // aggregation function
  ctrl.append("select")
    .attr("class", "aggr")
    .on("change", update)
    .selectAll("option")
      .data(["-", "avg", "sum", "min", "max", "count", "bin"])
    .enter().append("option")
      .attr("value", function(d) { return d; })
      .text(function(d) { return d; });

  // data variable
  ctrl.append("select")
    .attr("class", "shelf")
    .on("change", update)
    .selectAll("option")
      .data(["-"], function(d) { return d; })
    .enter().append("option")
      .attr("value", function(d) { return d; })
      .text(function(d) { return d; });

  // data type (ordinal, quantitative or time)
  ctrl.append("select")
    .attr("class", "type")
    .on("change", update)
    .selectAll("option")
      .data(["-", "O", "Q", "T"])
    .enter().append("option")
      .attr("value", function(d) { return d; })
      .text(function(d) { return d; });

  // Toggle Inspect / Config Form
  var toggles = main.append("div").attr("class","toggles");

  var vlcodeToggle = toggles.append("label");
  vlcodeToggle.append("input").attr("type", "checkbox")
    .on("change", function(){
      vlcode.style("display", this.checked ? "block" : "none");
    });
  vlcodeToggle.append("span").text("Vegalite Code");


  var vgcodeToggle = toggles.append("label");
  vgcodeToggle.append("input").attr("type", "checkbox")
    .on("change", function(){
      vgcode.style("display", this.checked ? "block" : "none");
    });
  vgcodeToggle.append("span").text("Vega Code");

  var configToggle = toggles.append("label");
  configToggle.append("input").attr("type", "checkbox")
    .on("change", function(){
      config.style("display", this.checked ? "block" : "none");
    });
  configToggle.append("span").text("Config");

  // Code Pane

  vlcode.append("span").text("Vegalite");
  var vlTextarea = vlcode.append("textarea").attr("class", "vlcode");

  vgcode.append("span").text("Vega")
  var vgTextarea = vgcode.append("textarea").attr("class", "vgcode");

  // Config Pane
  config.append("input").attr("type","button").attr("value","Update Config")
    .on("click", update);

  var configs = config.selectAll("div")
    .data(vl.keys(vl.DEFAULTS))
    .enter().append("div").attr("class", "cfg")
      .append("label");

  configs.append("span").attr("class","label").text(function(d){return d;});
  configs.append("input")
    .attr("placeholder", function(d){return vl.DEFAULTS[d];});
}

function run(data, schema) {
  // CURRENTLY EXPECTED AS GLOBAL VARS...
  self.data = data;
  self.schema = schema;

  var s = d3.selectAll("select.shelf").selectAll("option")
    .data(["-"].concat(d3.keys(schema)), function(d) { return d; });
  s.enter().append("option")
    .attr("value", function(d) { return d; })
    .text(function(d) { return d; })
  s.exit().remove();
}

function update() {
  var enc = encodings();
  self.enc = enc; // DEBUG
  self.spec = vl.toVegaSpec(enc, data);
  d3.select("textarea.vlcode").text(self.enc.toJSON("  "));
  d3.select("textarea.vgcode").text(JSON.stringify(self.spec, null, "  ", 60));
  parse(self.spec, data);
}

function encodings() {
  var marktype = "bar",
      bin = null,
      enc = {},
      cfg = {};

  var types = vl.dataTypes;

  var s = d3.select("select.mark").node();
  marktype = s.options[s.selectedIndex].value;

  d3.selectAll("#ctrl div.enc").each(function(d) {
    var x = d;
    var s = d3.select(this).select("select.shelf").node();
    var v = s.options[s.selectedIndex].value;

    var s = d3.select(this).select("select.type").node();
    var t = s.options[s.selectedIndex].value;

    var s = d3.select(this).select("select.aggr").node();
    var a = s.options[s.selectedIndex].value;

    if (v !== "-" || a === "count") {
      enc[x] = {
        name: v,
        type: (a==="count" ? types.Q : t==="-" ? schema[v] : types[t])
      };

      if (a === "bin") {
        enc[x].bin = true;
      } else if (a !== "-") {
        enc[x].aggr = a;
      }
    }
  });

  d3.selectAll("#ctrl div.cfg input").each(function(d){
    var val = this.value;
    if(val && val.length > 0){
      cfg[d] = {value: val};
    }
  });
  return new vl.Encoding(marktype, enc, cfg);
}

function parse(spec, data) {
  self.vis = null; // DEBUG
  vg.parse.spec(spec, function(chart) {
    self.vis = chart({el:"#vis", renderer: "svg"});
    vis.data({table: data}).update();
  });
}

init();
</script>
</body>
</html>